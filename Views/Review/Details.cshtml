@model Coursework.Models.Review
@inject MarkdownToHtmlService _markdownToHtmlService
@inject IHtmlLocalizer<SharedResource> _sharedLocalizer

@{
    ViewData["Title"] = "Review";
}

<link rel="stylesheet" href="~/lib/bootstrap-star-rating/themes/krajee-svg/theme.min.js" />

<div class="border rounded-2 p-2">
    <div class="col-md-12">
        <div class="pb-3 mb-4 border-bottom d-flex">
            <a class="d-flex align-items-center text-muted text-decoration-none">
                <img class="mb-0 me-2 rounded-circle" src="@Model.Author.AvatarUrl" width="32" height="32" alt="Avatar">
                <span>@Model.Author.UserName</span>
            </a>

            <div class="d-flex col-md-10 align-items-center justify-content-center text-center text-wrap text-break ms-2">
                <h2>@Model.Title</h2>
            </div>
        </div>
    </div>

    <div class="col-md-12">
        @Html.Raw(_markdownToHtmlService.ConvertMarkdownToHtml(Model.Text))
    </div>
</div>

@if (User.Identity.IsAuthenticated)
{
    <br />
    <label for="ratingInput" class="d-block">@_sharedLocalizer["RatingThisReview"] </label>
    <input id="ratingInput" name="input-name" type="number" class="rating" style="width: 0" data-size="sm"
           data-show-clear="false" min="0" max="5" value="@ViewBag.Rating" step="1" data-show-caption="true"
           data-keyboard-enabled="false" data-container-class="d-inline" />
    <br />
}

<div class="mt-2">
    @if (User.Identity.IsAuthenticated)
    {

        @if (!ViewBag.IsLiked)
        {
            <button id="likeBtn" class="btn btn-success ms-1">@_sharedLocalizer["Like"]</button>
        }
        else
        {
            <button id="likeBtn" class="btn btn-danger ms-1">@_sharedLocalizer["Dislike"]</button>
        }
    }
    <label id="likes" class="form-label ms-1">@_sharedLocalizer["LikesCount"]:  @ViewBag.Likes</label>
</div>

<div class="row">
    <div class="col">
        @foreach (var comment in @Model.Comments)
        {
            await Html.RenderPartialAsync("CommentPartial", comment);
        }
    </div>
</div>
   

@section Scripts
{
        <script>
        $(document).ready(function() {
            $("#ratingInput").rating().on("rating:change",
                function(event, value, caption) {
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("SetRating", "Review")',
                        data: {
                            reviewId: @Model.Id,
                            rating: value
                        }
                    });
                });
            $("#likeBtn").click(function() {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("ToggleLike", "Review")',
                    data: {
                        reviewId: '@Model.Id'
                    },
                    success: function(data) {
                        $("#likeBtn").toggleClass('btn-danger');
                        $("#likeBtn").toggleClass('btn-success');
                        if ($("#likeBtn").hasClass('btn-success'))
                            $("#likeBtn").html('@_sharedLocalizer["Like"]');
                        else
                            $("#likeBtn").html('@_sharedLocalizer["Dislike"]');
                        $("#likes").html("@_sharedLocalizer["LikesCount"]:" + data);
                    }
                });
            });
        });
        </script>
    }

